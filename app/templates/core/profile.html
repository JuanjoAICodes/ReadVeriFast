{% extends "base.html" %}

{% block content %}
<article>
    <header>
        <h2>Perfil de {{ user.email }}</h2>
    </header>

    <!-- Estadísticas del Usuario -->
    <div class="grid">
        <article>
            <hgroup>
                <h3>{{ user.total_xp }}</h3>
                <h4>XP (Experiencia Total)</h4>
            </hgroup>
        </article>
        <article>
            <hgroup>
                <h3>{{ user.current_wpm }}</h3>
                <h4>Velocidad de Lectura (PPM)</h4>
            </hgroup>
        </article>
        <article>
            <hgroup>
                <h3>{{ attempts | length }}</h3>
                <h4>Artículos Leídos</h4>
            </hgroup>
        </article>
    </div>

    <!-- Selector de Tema -->
    <fieldset>
        <label for="theme-switch">
            <input type="checkbox" id="theme-switch" name="theme-switch" role="switch" {% if user.theme == 'dark' %}checked{% endif %}>
            Activar Tema Oscuro
        </label>
    </fieldset>

    <!-- Historial de Lectura -->
    <section id="reading-history" style="margin-top: 2rem;">
        <h3>Historial de Lectura</h3>
        {% if attempts %}
        <figure>
            <table>
                <thead>
                    <tr>
                        <th scope="col">Artículo</th>
                        <th scope="col">Puntuación</th>
                        <th scope="col">Fecha</th>
                    </tr>
                </thead>
                <tbody>
                    {% for attempt in attempts %}
                    <tr>
                        <td><a href="{{ url_for('core.article_detail', article_id=attempt.article.id) }}">{{ attempt.article.title or 'Artículo sin título' }}</a></td>
                        <td>{{ "%.0f"|format(attempt.score) }}%</td>
                        <td><small>{{ attempt.timestamp.strftime('%d %b, %Y') }}</small></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </figure>
        {% else %}
        <p>Aún no has completado ningún cuestionario.</p>
        {% endif %}
    </section>
</article>

<script>
document.getElementById('theme-switch').addEventListener('change', function() {
    const theme = this.checked ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', theme);
    
    // Enviar la preferencia al servidor
    fetch("{{ url_for('core.set_theme') }}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        },
        body: JSON.stringify({ theme: theme })
    });
});
</script>
{% endblock %}