{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}

<div class="container">
    <!-- CONTENEDOR 1: TODO LO QUE SE OCULTA AL PRINCIPIO -->
    <div class="content-to-hide">
        <!-- Título y Metadatos -->
        {% if article.image_url %}
            <img src="{{ article.image_url }}" alt="Imagen principal del artículo" class="article-detail-image">
        {% endif %}
        <h1>{{ article.title }}</h1>
        <div class="article-meta">
            <h2>{{ _('Submitted by') }} {{ article.author.email }} {{ _('on') }} {{ article.timestamp.strftime('%Y-%m-%d') }}</h2>
            {% if article.tags %}
            <div>
                <strong>{{ _('Tags:') }}</strong>
                {% for tag in article.tags %}
                    <a href="{{ url_for('core.articles_by_tag', tag_name=tag.name) }}" style="text-decoration: none;">
                        <span class="badge bg-secondary">{{ tag.name }}</span>
                    </a>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        <hr>
    </div>

    <!-- Interfaz de Lectura Rápida -->
    <div class="speed-reader-container">
        <div id="word-display" class="word-display-box" data-text-start="{{ _('Click on Start') }}" data-text-stopped="{{ _('Reading stopped.') }}" data-text-finished="{{ _('Reading Finished!') }}">{{ _('Click on Start') }}</div>
        <div class="speed-controls">
            <span>{{ _('Speed:') }} </span>
            <input type="number" id="wpm-input" value="{{ current_wpm }}" min="100" max="{{ max_wpm }}" step="25">
            <button id="start-reading-button" data-btn-start="{{ _('Start') }}" data-btn-stop="{{ _('Stop') }}">{{ _('Start') }}</button>
            <span id="wpm-display">{{ current_wpm }} / {{ max_wpm }} WPM</span>
        </div>
    </div>
    
    <!-- El texto completo del artículo, oculto para que JS lo use -->
    <div id="article-text-source" style="display: none;">{{ article.clean_content }}</div>

    <!-- CONTENEDOR 3: TODO LO QUE SE OCULTA AL FINAL -->
    <div class="content-to-hide">
        <hr>
        <div class="quiz-container">
            <h2>{{ _('Comprehension Quiz') }}</h2>

            {% if quiz_questions and quiz_questions.questions %}
                <form action="{{ url_for('core.submit_quiz', article_id=article.id) }}" method="post">
                    {# Para usar la protección CSRF de Flask-WTF #}
                    {{ form.hidden_tag() }} 

                    {# Campo oculto para enviar el WPM usado, se actualiza con JS #}
                    <input type="hidden" name="wpm_used" id="wpm_used_input" value="{{ current_wpm }}">

                    {% for question_data in quiz_questions.questions %}
                        {% set question_index = loop.index %} {# Capturamos el índice de la pregunta #}
                        <div class="question">
                            <p><strong>{{ question_index }}. {{ question_data.question }}</strong></p>
                            
                            {% for option in question_data.options %}
                                <div>
                                    <input type="radio" name="question_{{ question_index }}" id="q{{ question_index }}_opt{{ loop.index0 }}" value="{{ option }}" required>
                                    <label for="q{{ question_index }}_opt{{ loop.index0 }}">{{ option }}</label>
                                </div>
                            {% endfor %}
                        </div>
                    {% endfor %}
                    <br>
                    <input type="submit" value="{{ _('Submit Answers') }}">
                </form>
            {% else %}
                <p>{{ _('The quiz for this article is not yet available.') }}</p>
            {% endif %}
        </div>
        <hr>
        <a href="{{ url_for('core.index') }}">{{ _('Back to list') }}</a>
    </div>
</div>

<!-- El Script de JavaScript -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Elementos del DOM
        const startBtn = document.getElementById('start-reading-button');
        const readerBox = document.getElementById('word-display');
        const ppmInput = document.getElementById('wpm-input');
        const wpmDisplay = document.getElementById('wpm-display');
        const wpmUsedInput = document.getElementById('wpm_used_input');
        const textSource = document.getElementById('article-text-source');
        const body = document.body;
        // Textos para traducción
        const textStart = readerBox.dataset.textStart;
        const textStopped = readerBox.dataset.textStopped;
        const textFinished = readerBox.dataset.textFinished;
        const btnStart = startBtn.dataset.btnStart;
        const btnStop = startBtn.dataset.btnStop;
        const maxWpm = {{ max_wpm }};

        // Estado de la aplicación
        let words = [];
        let currentIndex = 0;
        let intervalId = null;

        if (textSource && textSource.textContent) {
            words = textSource.textContent.trim().split(/\s+/);
        }

        // Función para detener la lectura y el modo enfoque
        function stopReading() {
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
            }
            body.classList.remove('focus-mode-active'); // Desactiva el modo enfoque
            startBtn.textContent = btnStart;
        }

        // Evento principal para el botón de empezar/detener
        startBtn.addEventListener('click', () => {
            console.log("¡Botón 'Empezar' pulsado! Intentando activar modo enfoque...");
            if (intervalId) {
                stopReading();
                readerBox.textContent = textStopped;
                return;
            }

            console.log('Antes de añadir la clase, el body es:', body);
            const ppm = parseInt(ppmInput.value, 10);
            if (ppm <= 0 || words.length === 0) return;

            body.classList.add('focus-mode-active');
            startBtn.textContent = btnStop;

            const interval = 60000 / ppm;
            currentIndex = 0;
            intervalId = setInterval(() => {
                if (currentIndex < words.length) {
                    readerBox.textContent = words[currentIndex];
                    currentIndex++;
                } else {
                    stopReading();
                    readerBox.textContent = textFinished;
                }
            }, interval);
        });

        // Event listener para la tecla 'Escape' para salir del modo enfoque
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && body.classList.contains('focus-mode-active')) {
                stopReading();
                readerBox.textContent = textStopped;
            }
        });

        // Event listener para actualizar la velocidad
        ppmInput.addEventListener('input', () => {
            const currentWpm = ppmInput.value;
            if (wpmDisplay) {
                wpmDisplay.textContent = `${currentWpm} / {{ max_wpm }} WPM`;
            }
            if (wpmUsedInput) {
                wpmUsedInput.value = currentWpm;
            }
        });
    });
</script>
{% endblock %}